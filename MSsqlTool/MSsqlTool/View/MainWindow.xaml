<Window
    x:Class="MSsqlTool.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:ei="http://schemas.microsoft.com/expression/2010/interactions"
    xmlns:i="http://schemas.microsoft.com/expression/2010/interactivity"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:dm="clr-namespace:MSsqlTool.Model"
    x:Name="CurrentWindow"
    Title="MSsqlTool"
    MaxWidth="1680"
    MaxHeight="1050"
    MinWidth="840"
    MinHeight="525"
    DataContext="{Binding Source={StaticResource Locator}, Path=Main}"
    Icon="/MSsqlTool;component/Icons/SQL.png"
    Style="{DynamicResource WindowTitleStyle}"
    TextElement.FontSize="16"
    TextElement.FontWeight="Medium"
    WindowStartupLocation="CenterScreen"
    WindowState="Normal"
    mc:Ignorable="d">
    <Window.Resources>
        <ResourceDictionary Source="../Styles/mainWindowStyle.xaml" />
    </Window.Resources>
    <Grid 
        MaxWidth="{x:Static SystemParameters.MaximumWindowTrackWidth}" 
        MaxHeight="{x:Static SystemParameters.MaximumWindowTrackHeight}">
        <Grid.RowDefinitions>
            <RowDefinition Height="40" />
            <RowDefinition Height="*" />
            <RowDefinition Height="5px" />
        </Grid.RowDefinitions>
        <Grid
            Grid.Row="0"
            Background="#3448a1"
            WindowChrome.IsHitTestVisibleInChrome="True">
            <i:Interaction.Triggers>
                <i:EventTrigger EventName="MouseLeftButtonDown">
                    <ei:CallMethodAction MethodName="DragMove" TargetObject="{Binding ElementName=CurrentWindow}" />
                </i:EventTrigger>
            </i:Interaction.Triggers>
            <Image
                Margin="10,10,0,5"
                HorizontalAlignment="Left"
                Source="../Icons/logo.png"
                Stretch="Uniform"
                StretchDirection="Both" />
            <Button
                Width="20px"
                Height="20px"
                Margin="0,0,70,0"
                HorizontalAlignment="Right"
                VerticalAlignment="Center"
                Background="#3448a1"
                Style="{StaticResource TitleMinimizeButtonStyle}"
                ToolTip="最小化">
                <i:Interaction.Triggers>
                    <i:EventTrigger EventName="Click">
                        <ei:ChangePropertyAction
                            PropertyName="WindowState"
                            TargetObject="{Binding ElementName=CurrentWindow}"
                            Value="Minimized" />
                    </i:EventTrigger>
                </i:Interaction.Triggers>
                <Canvas>
                    <Path
                        Canvas.Top="6"
                        Canvas.Right="-6"
                        Width="12"
                        Height="1"
                        Data="F1M0,1L12.001,1 12.001,0 0,0z"
                        Fill="#FF9AA4D0" />
                </Canvas>
            </Button>
            <Button
                Width="20px"
                Height="20px"
                Margin="5,0,40,0"
                HorizontalAlignment="Right"
                VerticalAlignment="Center"
                Background="#3448a1"
                Style="{StaticResource TitleNormalButtonStyle}">
                <Canvas>
                    <Path
                        Canvas.Left="-6"
                        Canvas.Top="-6"
                        Width="12"
                        Height="12"
                        Fill="#FF9AA4D0"
                        Style="{StaticResource RestorePathStyle}"/>
                </Canvas>
            </Button>
            <Button
                Width="20px"
                Height="20px"
                Margin="5,0,10,0"
                HorizontalAlignment="Right"
                VerticalAlignment="Center"
                Style="{StaticResource TitleCloseButtonStyle}"
                ToolTip="关闭">
                <i:Interaction.Triggers>
                    <i:EventTrigger EventName="Click">
                        <ei:CallMethodAction MethodName="Close" TargetObject="{Binding ElementName=CurrentWindow}" />
                    </i:EventTrigger>
                </i:Interaction.Triggers>
                <Grid>
                    <Canvas>
                        <Path
                            Canvas.Top="-6"
                            Canvas.Right="-6"
                            Width="12"
                            Height="12"
                            Data="F1M11.706,0.706L11,0 5.852,5.146 0.706,0 -0.001,0.706 5.146,5.852 -0.001,11 0.706,11.706 5.852,6.56 11,11.706 11.706,11 6.56,5.852z"
                            Fill="#FFA0A9D3" />
                    </Canvas>
                </Grid>
            </Button>
        </Grid>
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="5px" />
                <ColumnDefinition Width="3*" />
                <ColumnDefinition Width="5px" />
                <ColumnDefinition Width="17*" />
                <ColumnDefinition Width="5px" />
            </Grid.ColumnDefinitions>
            <Grid Grid.Column="0" Background="#3448a1" />
            <Grid Grid.Column="1">
                <TreeView
                    HorizontalContentAlignment="Left"
                    ItemContainerStyle="{StaticResource TreeViewMainItemStyle}"
                    ItemsSource="{Binding MainDatabaseList}">
                    <TreeView.ItemTemplate>
                        <HierarchicalDataTemplate
                            DataType="{x:Type dm:SqlMenuModel}"
                            ItemContainerStyle="{StaticResource TreeViewItemStyle}"
                            ItemsSource="{Binding MenuTables}">
                            <StackPanel Margin="-5px" Orientation="Horizontal">
                                <Image
                                    x:Name="Icon"
                                    Width="15px"
                                    Height="15px"
                                    Source="{Binding Converter={StaticResource IconPathConverter}, Path=Level}" />
                                <TextBlock Margin="5" Text="{Binding Name}" />
                            </StackPanel>
                        </HierarchicalDataTemplate>
                    </TreeView.ItemTemplate>
                    <TreeView.ContextMenu>
                        <ContextMenu Style="{StaticResource LonwinContextMenu}">
                            <MenuItem Command="{Binding ImportCommand}" Header="导入" />
                            <MenuItem Command="{Binding RefreshCommand}" Header="刷新" />
                        </ContextMenu>
                    </TreeView.ContextMenu>
                </TreeView>
            </Grid>
            <Grid Grid.Column="2" Background="#3448a1" />
            <Grid Grid.Column="3">
                <Grid.RowDefinitions>
                    <RowDefinition Height="50px" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="50px" />
                </Grid.RowDefinitions>
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="95*" />
                        <ColumnDefinition Width="5*" />
                    </Grid.ColumnDefinitions>
                    <StackPanel
                        x:Name="TableStackPanel"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch">
                        <ListView ItemsSource="{Binding OpenedTableList}">
                            <ListView.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel IsItemsHost="True" Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ListView.ItemsPanel>
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Viewbox>
                                        <Grid>
                                            <materialDesign:Chip
                                                x:Name="Chip"
                                                Width="{Binding Converter={StaticResource PercentageConverter}, ElementName=TableStackPanel, Path=ActualWidth, ConverterParameter=0.16}"
                                                Height="50px"
                                                Margin="-10,-8,-9,0"
                                                HorizontalAlignment="Stretch"
                                                VerticalAlignment="Stretch"
                                                Command="{Binding Source={StaticResource Locator}, Path=Main.ClickTabCommand}"
                                                CommandParameter="{Binding TableFullName}"
                                                Content="{Binding TableName}"
                                                DeleteCommand="{Binding Source={StaticResource Locator}, Path=Main.CloseTabCommand}"
                                                DeleteCommandParameter="{Binding TableFullName}"
                                                IsDeletable="True"
                                                IsTabStop="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=ListViewItem}, Path=IsSelected}"
                                                Style="{StaticResource TabChip}"
                                                ToolTip="{Binding TableName}">
                                                <materialDesign:Chip.ContextMenu>
                                                    <ContextMenu Style="{StaticResource LonwinContextMenu}">
                                                        <MenuItem
                                                            Command="{Binding Source={StaticResource Locator}, Path=Main.CloseTabCommand}"
                                                            CommandParameter="{Binding TableFullName}"
                                                            Header="关闭" />
                                                        <MenuItem
                                                            Command="{Binding Source={StaticResource Locator}, Path=Main.CloseOtherTabsCommand}"
                                                            CommandParameter="{Binding TableFullName}"
                                                            Header="关闭其他文档" />
                                                        <MenuItem Command="{Binding Source={StaticResource Locator}, Path=Main.CloseAllTabsCommand}" Header="关闭所有文档" />
                                                    </ContextMenu>
                                                </materialDesign:Chip.ContextMenu>
                                            </materialDesign:Chip>
                                        </Grid>
                                    </Viewbox>
                                    <DataTemplate.Triggers>
                                        <DataTrigger Binding="{Binding IsChoosed}" Value="true">
                                            <Setter TargetName="Chip" Property="Background" Value="#283a89" />
                                            <Setter TargetName="Chip" Property="Foreground" Value="White" />
                                        </DataTrigger>
                                    </DataTemplate.Triggers>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </StackPanel>
                    <Grid Grid.Column="1">
                        <materialDesign:PopupBox
                            HorizontalAlignment="Center"
                            PlacementMode="BottomAndAlignRightEdges"
                            Visibility="{Binding Converter={StaticResource BoolToVisibleConverter}, Source={StaticResource Locator}, Path=Main.IsTabFoldOpened}">
                            <materialDesign:PopupBox.ToggleContent>
                                <Canvas>
                                    <Path
                                        Canvas.Left="0"
                                        Canvas.Top="0"
                                        Width="9"
                                        Height="5"
                                        Data="F1M0,0L0,1 1,1 1,2 2,2 2,3 3,3 3,4 4,4 4,5 5,5 5,4 6,4 6,3 7,3 7,2 8,2 8,1 9,1 9,0z"
                                        Fill="#FF868999" />
                                </Canvas>
                            </materialDesign:PopupBox.ToggleContent>
                            <ListView ItemsSource="{Binding OpenedTableFoldedList}">
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <materialDesign:Chip
                                            x:Name="Chip"
                                            Width="{Binding Converter={StaticResource PercentageConverter}, ElementName=TableStackPanel, Path=ActualWidth, ConverterParameter=0.12}"
                                            Height="30px"
                                            Command="{Binding Source={StaticResource Locator}, Path=Main.ClickFoldCommand}"
                                            CommandParameter="{Binding TableFullName}"
                                            Content="{Binding TableName}"
                                            DeleteCommand="{Binding Source={StaticResource Locator}, Path=Main.CloseFoldTabCommand}"
                                            DeleteCommandParameter="{Binding TableFullName}"
                                            IsDeletable="True" />
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </materialDesign:PopupBox>
                    </Grid>
                </Grid>
                <Grid Grid.Row="1">
                    <DataGrid
                        x:Name="TableDataGrid"
                        Margin="0,0,0,0"
                        Background="White"
                        BorderThickness="0"
                        CanUserAddRows="True"
                        CanUserDeleteRows="True"
                        CanUserSortColumns="False"
                        CellStyle="{StaticResource DataGridCellStyle}"
                        ColumnHeaderStyle="{StaticResource DataGridColumnHeaderStyle}"
                        GridLinesVisibility="All"
                        ItemsSource="{Binding TableData.DataInTable, Mode=TwoWay}"
                        SelectionMode="Extended"
                        Style="{StaticResource LonwinDataGrid}"
                        Visibility="{Binding Converter={StaticResource BoolToVisibleConverter}, Source={StaticResource Locator}, Path=Main.IsDataGridOpened}">
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn
                                Width="40"
                                Binding="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type DataGridRow}}, Path=IsSelected}"
                                CanUserResize="False"
                                CellStyle="{StaticResource DataGridCheckBoxCellStyle}"
                                ElementStyle="{StaticResource MaterialDesignDataGridCheckBoxColumnStyle}">
                                <DataGridCheckBoxColumn.HeaderTemplate>
                                    <DataTemplate>
                                        <CheckBox
                                            x:Name="CheckBoxAll"
                                            Height="40"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Command="{Binding Source={StaticResource Locator}, Path=Main.SelectAllCommand}"
                                            CommandParameter="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type DataGrid}}}"
                                            IsChecked="{Binding Source={StaticResource Locator}, Path=Main.IsAllSelected, Mode=TwoWay}"
                                            IsEnabled="{Binding Source={StaticResource Locator}, Path=Main.IsDataGridOpened}"
                                            ToolTip="全选/全不选" />
                                    </DataTemplate>
                                </DataGridCheckBoxColumn.HeaderTemplate>
                            </DataGridCheckBoxColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
                <Grid Grid.Row="2">
                    <Button
                        Width="100px"
                        Command="{Binding ApplyUpdateCommand}"
                        CommandParameter="{Binding ElementName=TableDataGrid, Path=DataContext}"
                        Content="应用修改"
                        Style="{StaticResource MaterialDesignFlatMidBgButton}"
                        Visibility="{Binding Converter={StaticResource BoolToVisibleConverter}, Source={StaticResource Locator}, Path=Main.IsDataGridOpened}" />
                </Grid>
            </Grid>
            <Grid Grid.Column="4" Background="#3448a1" />
        </Grid>
        <Grid Grid.Row="2" Background="#3448a1" />
    </Grid>

</Window>
